
import { useState, useMemo } from 'react';
import { toast } from 'sonner';
import type { User, Exercise } from '../../types';
import type { ProgramStructure } from './useProgramBuilderState';
import { assignmentService } from '../services/assignmentService';
import { groupAssignmentService } from '../services/groupAssignmentService';

interface UseProgramBuilderDialogLogicProps {
  users: User[];
  exercises: Exercise[];
  onCreateProgram: (program: any) => Promise<any>;
  onOpenChange: () => void;
  editingProgram?: any;
  editingAssignment?: any;
  isOpen: boolean;
  program: ProgramStructure;
}

export const useProgramBuilderDialogLogic = ({
  users,
  exercises,
  onCreateProgram,
  onOpenChange,
  editingProgram,
  editingAssignment,
  isOpen,
  program
}: UseProgramBuilderDialogLogicProps) => {
  const [assignmentDialogOpen, setAssignmentDialogOpen] = useState(false);

  const availableUsers = useMemo(() => {
    return users.filter(user => 
      user.role === 'athlete' || 
      user.role === 'user' || 
      !user.role  // Include users without role defined
    );
  }, [users]);

  const handleClose = () => {
    onOpenChange();
  };

  const handleSave = async () => {
    try {
      console.log('ğŸ’¾ Saving program:', program);
      
      if (!program.name?.trim()) {
        toast.error('Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚ ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÏŒ');
        return;
      }

      const savedProgram = await onCreateProgram(program);
      console.log('âœ… Program saved:', savedProgram);
      
      toast.success('Î¤Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
      handleClose();
    } catch (error) {
      console.error('âŒ Error saving program:', error);
      toast.error('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚');
    }
  };

  const handleOpenAssignments = () => {
    if (!program.name?.trim()) {
      toast.error('Î ÏÏÏ„Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏƒÏ„Îµ Ï„Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î±');
      return;
    }
    setAssignmentDialogOpen(true);
  };

  const handleAssign = async (
    userId: string, 
    trainingDates: string[], 
    assignmentType: 'individual' | 'group' = 'individual',
    groupId?: string
  ) => {
    try {
      console.log('ğŸ¯ Starting assignment process:', { assignmentType, userId, groupId, trainingDates });

      if (!program.id) {
        // Save program first if it doesn't have an ID
        const savedProgram = await onCreateProgram(program);
        if (!savedProgram || !savedProgram.id) {
          throw new Error('Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ Ï€ÏÎ¿Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚');
        }
        program.id = savedProgram.id;
      }

      if (assignmentType === 'group' && groupId) {
        console.log('ğŸ‘¥ Creating group assignment');
        const result = await groupAssignmentService.assignProgramToGroup(
          groupId,
          program,
          trainingDates
        );
        
        toast.success(`Î¤Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Î½Î±Ï„Î­Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ ÏƒÏ„Î·Î½ Î¿Î¼Î¬Î´Î±! Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎ±Î½ ${result.totalMembers} Î±Ï„Î¿Î¼Î¹ÎºÎ­Ï‚ Î±Î½Î±Î¸Î­ÏƒÎµÎ¹Ï‚.`);
      } else {
        console.log('ğŸ‘¤ Creating individual assignment');
        const assignmentData = {
          program,
          userId,
          trainingDates
        };

        await assignmentService.saveAssignment(assignmentData);
        toast.success('Î¤Î¿ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Î½Î±Ï„Î­Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!');
      }

      setAssignmentDialogOpen(false);
      handleClose();

      // Redirect to active programs
      setTimeout(() => {
        window.location.href = '/dashboard/active-programs';
      }, 1500);

    } catch (error) {
      console.error('âŒ Assignment error:', error);
      toast.error(`Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î¸ÎµÏƒÎ·Ï‚: ${error instanceof Error ? error.message : 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±'}`);
    }
  };

  return {
    assignmentDialogOpen,
    setAssignmentDialogOpen,
    handleClose,
    handleSave,
    handleOpenAssignments,
    handleAssign,
    availableUsers,
    editingAssignment: editingAssignment
  };
};
